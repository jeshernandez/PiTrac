<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li:not(:nth-child(4)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(4) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(2) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(1) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(1) > ul > li:nth-child(4) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list > li.nav-list-item:nth-child(4) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Camera Lens Undistortion Process | PiTrac</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Camera Lens Undistortion Process" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Documentation for PiTrac" /> <meta property="og:description" content="Documentation for PiTrac" /> <link rel="canonical" href="http://localhost:4000/camera/camera_calibration_undistortion_process.html" /> <meta property="og:url" content="http://localhost:4000/camera/camera_calibration_undistortion_process.html" /> <meta property="og:site_name" content="PiTrac" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Camera Lens Undistortion Process" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Documentation for PiTrac","headline":"Camera Lens Undistortion Process","url":"http://localhost:4000/camera/camera_calibration_undistortion_process.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> PiTrac </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Home category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/" class="nav-list-link">Home</a><ul class="nav-list"><li class="nav-list-item"><a href="/thisdoc.html" class="nav-list-link">About this Document</a></li><li class="nav-list-item"><a href="/terminology.html" class="nav-list-link">Terminology</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Cameras category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/camera/cameras.html" class="nav-list-link">Cameras</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Calibration category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/camera/camera_calibration.html" class="nav-list-link">Calibration</a><ul class="nav-list"><li class="nav-list-item"><a href="/camera/camera_calibration_initial_setup.html" class="nav-list-link">Initial Setup</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Tee Camera (top) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/camera/camera_calibration_tee_camera.html" class="nav-list-link">Tee Camera (top)</a><ul class="nav-list"><li class="nav-list-item"><a href="/camera/camera_calibration_tee_camera_focal.html" class="nav-list-link">Determine the cameras focal length</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Flight Camera (bottom) category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/camera/camera_calibration_flight_camera.html" class="nav-list-link">Flight Camera (bottom)</a><ul class="nav-list"><li class="nav-list-item"><a href="/camera/camera_calibration_flight_camera_CCFL.html" class="nav-list-link">Calibrate Focal Point Length</a></li><li class="nav-list-item"><a href="/camera/camera_calibration_flight_camera_calibration.html" class="nav-list-link">Camera Calibration Confirmation</a></li></ul></li><li class="nav-list-item"><a href="/camera/camera_calibration_undistortion_process.html" class="nav-list-link">Camera Lens Undistortion Process</a></li></ul></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 3D Print category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/3dprint/3dprint.html" class="nav-list-link">3D Print</a><ul class="nav-list"><li class="nav-list-item"><a href="/3dprint/3dprint_base_layer_piside_floor.html" class="nav-list-link">3d Print Base Layer Pi Side Floor</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search PiTrac" aria-label="Search PiTrac" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/jamespilgrim/PiTrac/tree/main/docs" class="site-button" > Edit Me </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/camera/cameras.html">Cameras</a></li> <li class="breadcrumb-nav-list-item"><a href="/camera/camera_calibration.html">Calibration</a></li> <li class="breadcrumb-nav-list-item"><span>Camera Lens Undistortion Process</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h2 id="camera-lens-undistortion-process"> <a href="#camera-lens-undistortion-process" class="anchor-heading" aria-labelledby="camera-lens-undistortion-process"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Camera Lens “Undistortion” Process </h2> <p>A camera lens undistortion process involves first calibrating the camera to determine the lens distortion parameters (like radial and tangential distortion coefficients), then using those parameters to mathematically map the distorted pixels in an image to their correct positions, creating an undistorted output image; this typically requires capturing images of a known pattern (like a checkerboard) to accurately calculate the distortion parameters.</p> <p>Camera Calibration and Geometry. Basics of camera geometry and how it can be used to calibrate cameras.</p> <iframe width="640" height="420" src="https://www.youtube.com/embed/_-BTKiamRTg" frameborder="0" allowfullscreen=""></iframe> <ul> <li>Here is another video performing a camera calibration in OpenCV using python in VS Code:</li> </ul> <iframe width="640" height="420" src="https://www.youtube.com/embed/H5qbRTikxI4" frameborder="0" allowfullscreen=""></iframe> <ol> <li>The undistortion code and scripts are under the <code class="language-plaintext highlighter-rouge">CalibrateCameraDistortions</code> folder. The scripts rely upon the libcamera-still utility, so make sure that is working first.</li> <li>Print out a copy of the <code class="language-plaintext highlighter-rouge">7x10</code> square checker board included in that directory on a sheet of paper. Note that you want to print it to scale. Mount the checkerboard on a piece of cardboard or slip it into a binder so that you can easily hold it and it will stay flat.</li> <li>When calibrating Flight camera, adding a bright incandescent light can provide additional IR light to help make the images clearer. Also, change the tuning file in the <code class="language-plaintext highlighter-rouge">take_calibration_shots.sh</code> script from: <ol> <li><code class="language-plaintext highlighter-rouge">--tuning-file=/usr/share/libcamera/ipa/rpi/pisp/imx296.json</code> to</li> <li><code class="language-plaintext highlighter-rouge">--tuning-file=/usr/share/libcamera/ipa/rpi/vc4/imx296_noir.json</code> (the _noir is only applicable for Flight camera)</li> </ol> </li> <li>When calibrating Tee camera, ensure the room is well lit. Turning on the LED strips on the LM often produces too much light and reflection.</li> <li>To take the pictures, make sure your camera is focused at the distance of where the ball will be. It’s best to have the Pi console window visible so that you can see when to move the board and avoid blurs.</li> <li>Next, we need a bunch of images of the checkerboard at about the distance we expect the golf ball to be imaged by the cameras. These images should include the board in the middle and nearer the edges of the images, and must each include all of the checkerboard, not just a part of it.</li> <li>Sample setup <ol> <li><img src="../assets/images/camera/image11.jpg" alt="" /></li> </ol> </li> <li>Then, run the <code class="language-plaintext highlighter-rouge">take_calibration_shots.sh</code> script, specifying, for example, <code class="language-plaintext highlighter-rouge">./images/cam1</code> as the output directory. Twenty pictures is usually sufficient. <ol> <li>→ <code class="language-plaintext highlighter-rouge">mkdir images/cam2</code> for flight camera</li> <li>→ <code class="language-plaintext highlighter-rouge">take_calibration_shots.sh</code> ./images/cam2/gs_calibation_20`</li> </ol> </li> <li>The script will repeatedly pause and take a picture and save it to the output directory. Each time the script says “READY”, quickly move the checkerboard to a new location. Each move, try to rotate the board a little bit about the image plane so that it is in a different orientation each time. Also, try tilting the board a little forward and back randomly. This should result in a set of images that are named <code class="language-plaintext highlighter-rouge">gs_calibrate_&lt;nn&gt;</code>, where nn is an increasing number. The images should look like:</li> <li><img src="../assets/images/camera/image12.png" alt="" /><img src="../assets/images/camera/image13.png" alt="" /><img src="../assets/images/camera/image14.png" alt="" /><img src="../assets/images/camera/image15.png" alt="" /></li> <li>Look through the images and delete any where the checkerboard is not fully visible. Partially-visible board can stall the next step of this process.</li> <li>Now that the pictures are ready, run the python processing script on those pictures to come up with the matrices that will be necessary to setup the PiTrac configuration .json file. To run, do: <ol> <li>First, edit the python script to point to the images just gathered, for example: <ol> <li><code class="language-plaintext highlighter-rouge">images = glob.glob('./images/cam1/*.png')</code></li> </ol> </li> <li>→ <code class="language-plaintext highlighter-rouge">rm caliResult*.png</code> (to remove any earlier calibration sanity-check files)</li> <li>Pick an output image to use as a test case: <ol> <li><code class="language-plaintext highlighter-rouge">cp images/cam2/gs_calibation_1.png</code> <code class="language-plaintext highlighter-rouge">test_image_for_undistortion.png</code></li> </ol> </li> <li>→ <code class="language-plaintext highlighter-rouge">python CameraCalibration.py</code></li> <li>Alternatively, there is a Visual Studio .sln solution file that you can open up in Studio to step through the code if there is a problem.</li> </ol> </li> <li>After processing, there will be several files output to the current working directory. If you compare <code class="language-plaintext highlighter-rouge">test_image_for_undistortion</code> and <code class="language-plaintext highlighter-rouge">caliResult2.png</code>, you can see the before and after results of applying the computed un-distortion matrices. The un-distorted picture should have each checkerboard square look the same size and they should look square, not rounded. The lines of rows and columns should be straight in the undistorted image. caliResult1.png shows how the original image is “warped” to un-distort it</li> <li> <p>If that looks good, take the information in the files <code class="language-plaintext highlighter-rouge">distortion.txt</code> and <code class="language-plaintext highlighter-rouge">cameraMatrix.txt</code> and copy the values into the two parameters below (changing <code class="language-plaintext highlighter-rouge">Camera2</code> (Flight camera) for <code class="language-plaintext highlighter-rouge">Camera1</code> (Tee camera) if this is for Flight camera). These parameters are in the “cameras” subsection of <code class="language-plaintext highlighter-rouge">golf_sim_config.json</code>:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"kCamera1CalibrationMatrix"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> 
</span><span class="p">[</span><span class="w"> </span><span class="mf">1.748506644661262953e+03</span><span class="p">,</span><span class="w"> </span><span class="mf">0.000000000000000000e+00</span><span class="p">,</span><span class="w"> </span><span class="mf">6.325374407393054526e+02</span><span class="w"> </span><span class="p">],</span><span class="w">  
</span><span class="p">[</span><span class="w"> </span><span class="mf">0.000000000000000000e+00</span><span class="p">,</span><span class="w"> </span><span class="mf">1.743341748687922745e+03</span><span class="p">,</span><span class="w"> </span><span class="mf">4.075677927449370941e+02</span><span class="w"> </span><span class="p">],</span><span class="w">  
</span><span class="p">[</span><span class="w"> </span><span class="mf">0.000000000000000000e+00</span><span class="p">,</span><span class="w"> </span><span class="mf">0.000000000000000000e+00</span><span class="p">,</span><span class="w"> </span><span class="mf">1.000000000000000000e+00</span><span class="w"> </span><span class="p">]]</span><span class="err">,</span><span class="w">  
</span></code></pre></div> </div> <p><code class="language-plaintext highlighter-rouge">"kCamera1DistortionVector": [ -0.504763 0.173410 0.001554 0.000916 0.355220 ]</code>,</p> </li> <li>Do the same for Tee camera and Flight camera</li> </ol> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <div class="d-flex mt-2"> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
